(()=>{function e(){document.write("正在刷新..."),location.reload()}function t(){var t=document.location.pathname.slice(1,100),a=JSON.parse(localStorage.getItem("chatroomhelper-chatrooms"));a.push(t),localStorage.setItem("chatroomhelper-chatrooms",JSON.stringify(a)),e()}function a(e){return e<10?"0"+e:""+e}function o(){var e=new Date;return`${e.getFullYear()}/${a(e.getMonth()+1)}/${a(e.getDate())} ${a(e.getHours())}:${a(e.getMinutes())}`}function n(){return async function(){var e=await(await fetch("")).text(),t=document.createElement("div");return t.innerHTML=e,t.getElementsByClassName("content")[0].value}().then((function(e){document.getElementsByClassName("content")[0].value=e}))}function c(){var t=window.open("about:blank","","popup=yes,width=600,height=400");t.document.write('<html><head><title>聊天室工具</title><script>setInterval(()=>{if(!window.opener)window.close();},500)<\/script><meta http-equiv="Content-Type"content="text/html;charset=utf-8"/></head><body><div style="outline: 1px dashed gray;"><h3><center>信息编辑器</center></h3><label>昵称</label><input id="nickname"><br><br><label>内容</label><textarea id="content"style="width:80%;height:100px;"></textarea><br><br><button id="submit">发送！</button></div><div><a id="disable"href="javascript:void(0)">禁用聊天室功能</a><br><a id="download"href="javascript:void(0)">下载页面备份</a><br><a id="update" href="javascript:void(0)">更新实时页面内容</a><br><a id="clear" href="javascript:void(0)">清除本工具全部数据（不可撤销）</a></div></body></html>'),t.document.getElementById("nickname").value=localStorage.getItem("chatroomhelper-nickname"),t.document.getElementById("submit").onclick=async function(){var e=t.document.getElementById("nickname").value;localStorage.setItem("chatroomhelper-nickname",e);new Date;var a=`\n${e}[${o()}]:\n${t.document.getElementById("content").value}`;t.document.getElementById("content").value="",localStorage.setItem("chatroomhelper-message-cache",a),await n(),r()},t.document.getElementById("download").onclick=function(){var e=document.getElementsByClassName("content")[0].value,t=new Blob([e],{type:"text/plain;charset=utf-8"}),a=URL.createObjectURL(t),n=document.createElement("a");n.href=a,n.download=`${document.location.pathname.slice(1,100)}-backup ${o().replaceAll("/","-").replaceAll(":",".")}.txt`,n.click(),URL.revokeObjectURL(a)},t.document.getElementById("clear").onclick=function(){localStorage.clear(),t.close(),e()},t.document.getElementById("disable").onclick=function(){var a=JSON.parse(localStorage.getItem("chatroomhelper-chatrooms"));a=a.filter((e=>e!=location.pathname.slice(1,100))),localStorage.setItem("chatroomhelper-chatrooms",JSON.stringify(a)),t.close(),e()},t.document.getElementById("update").onclick=async()=>await n()}function l(){null==localStorage.getItem("chatroomhelper-first-run")&&(localStorage.setItem("chatroomhelper-first-run","1"),localStorage.setItem("chatroomhelper-chatrooms","[]"),localStorage.setItem("chatroomhelper-message-cache",""),localStorage.setItem("chatroomhelper-state","0"),localStorage.setItem("chatroomhelper-nickname","匿名用户"+Math.round(1e4*Math.random()).toString()));var e=document.querySelector("div.flag"),a=document.createElement("a");e.appendChild(a);var o=document.location.pathname.slice(1,100);-1==JSON.parse(localStorage.getItem("chatroomhelper-chatrooms")).indexOf(o)?(a.onclick=t,a.innerText="这是一个聊天室"):(a.onclick=c,a.innerText="打开聊天室工具")}function r(){if(localStorage.getItem("chatroomhelper-message-cache")){for(var e=localStorage.getItem("chatroomhelper-message-cache"),t=document.getElementsByClassName("content")[0].value.split("\n"),a=-1,o=0;o<t.length;o++)if(t[o].startsWith("=‌=")){a=o;break}if(-1!=a){var n=t.slice(0,a).concat(e.split("\n")).concat(t.slice(a,1e8)).join("\n");document.getElementsByClassName("content")[0].value=n,localStorage.setItem("chatroomhelper-message-cache","")}else alert("没有找到定位标识，请手动添加定位标识后重试。")}}!function(){"use strict";l(),r()}()})();
